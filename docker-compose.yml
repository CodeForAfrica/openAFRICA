version: "3.7"

# docker-compose build && docker-compose up

services:
  ckan:
    build: .
    depends_on:
        - db
        - solr
        - redis
    ports:
        - "5000:5000"
    environment:
        - CKAN_SQLALCHEMY_URL=postgres://ckan_default:pass@db/ckan_default
        - CKAN_REDIS_URL=redis://redis:6379/0
        - CKAN_SOLR_URL=http://solr:8983/solr/ckan
        - CKAN_SITE_URL=http://localhost:5000
        - CKAN___BEAKER__SESSION__SECRET=supersecret
    env_file: env.dev
    volumes:
      - ./ckan.ini:/ckan.ini
      - ckan-filestore:/var/lib/ckan/default
  db:
    image: postgres:9.5
    ports:
      - "54321:5432"
    environment:
      - POSTGRES_USER=ckan_default
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=ckan_default
      - PGUSER=ckan_default
      - PGPASSWORD=pass

  datapusher:
    build: contrib/ckan-datapusher
    
  solr:
    image: openafrica/solr:latest
    ports:
        - "8983:8983"
    volumes:
      - solr-data:/opt/solr/server/solr/ckan

  redis:
    image: redis:latest
  

volumes:
  solr-data:
  ckan-filestore:
